<!DOCTYPE html>
<html lang="vi">
<head>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>B·∫£ng ƒëi·ªÅu khi·ªÉn - taskList</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/notification.css') }}">

    <style>
       
    </style>
</head>
<body>
      <div class="dashboard-layout">
        <aside class="sidebar">
            <a href="#home" class="sidebar__logo">TaskList</a>
            <nav class="sidebar__nav">
                <a href="/home" class="sidebar__nav-link active"><span>üìä</span>Trang ch·ªß</a>
                <a href="/profile" class="sidebar__nav-link"><span>üë§</span> H·ªì s∆° c√° nh√¢n</a>
                <a href="/team_list" class="sidebar__nav-link"><span>üë•</span> L√†m vi·ªác nh√≥m</a>
            </nav>
            <div class="sidebar__footer">
                <a href="/logout" class="sidebar__nav-link"><span>üö™</span> ƒêƒÉng xu·∫•t</a>
            </div>
        </aside>

        <main class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages">
                        {% for category, message in messages %}
                            <div class="flash-message flash-{{ category }}">{{ message }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <header class="main-header">
                <h1 class="main-header__title">üéâ Ch√†o m·ª´ng tr·ªü l·∫°i, {{ task.user_name or 'B·∫°n' }}!</h1>
                <p class="main-header__subtitle">ƒê√¢y l√† t·ªïng quan c√¥ng vi·ªác c·ªßa b·∫°n trong ng√†y h√¥m nay.</p>
            </header>

            <div class="dashboard-grid">
                <section class="card">
                    <h2 class="card__title"><span>üìù</span> T·∫°o C√¥ng Vi·ªác M·ªõi</h2>
                    <form action="/create/task" method="POST">
                        <div class="form-group">
                            <label for="task_title">T√™n c√¥ng vi·ªác:</label>
                            <input type="text" id="task_title" name="task_title" placeholder="V√≠ d·ª•: Ho√†n th√†nh b√°o c√°o" required>
                        </div>
                        <div class="form-group">
                            <label for="task_description">M√¥ t·∫£ chi ti·∫øt:</label>
                            <textarea id="task_description" name="task_description" rows="4" placeholder="Th√™m m√¥ t·∫£ c·ª• th·ªÉ v·ªÅ c√°c y√™u c·∫ßu c·ªßa c√¥ng vi·ªác..."></textarea>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="start_date">Ng√†y b·∫Øt ƒë·∫ßu:</label>
                                <input type="text" id="start_date" name="start_date" class="datetime-picker" placeholder="Ch·ªçn ng√†y gi·ªù" required>
                            </div>
                            <div class="form-group">
                                <label for="end_date">H·∫°n ch√≥t:</label>
                                <input type="text" id="end_date" name="end_date" class="datetime-picker" placeholder="Ch·ªçn ng√†y gi·ªù" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn--primary"><span>‚úÖ</span> Th√™m C√¥ng Vi·ªác</button>
                    </form>
                </section>
                <div class="task-list-container">
                    <h2 class="card__title"><span>üìã</span> Danh s√°ch C√¥ng Vi·ªác</h2>
                    <div class="task-list-controls">
                        <button id="showAllTasks" class="active">T·∫•t c·∫£</button>
                        <button id="showFinishedTasks">ƒê√£ ho√†n th√†nh</button>
                        <button id="showUnfinishedTasks">Ch∆∞a ho√†n th√†nh</button>
                    </div>
                    <div class="task-list">

                        {# --- V√≤ng l·∫∑p Jinja2 ƒë·ªÉ duy·ªát v√† l·ªçc c√¥ng vi·ªác --- #}
                        {% for t in task %}
                        <article class="task-card" data-status="{{ t.status_task | lower | default('unfinished') }}">
                            <div class="task-card__header">
                                <h3 class="task-card__title">{{ t.task_title }}</h3>
                                <span class="task-card__point">üèÜ {{ t.point_task or 'N/A' }} ƒêi·ªÉm</span>
                            </div>
                            <p class="task-card__description">{{ t.task_description }}</p>
                            <div class="task-card__footer">
                                <div class="task-card__date">
                                    <span>üóìÔ∏è</span>
                                    <strong>B·∫Øt ƒë·∫ßu:</strong> {{ t.start_date }} &nbsp;|&nbsp; <strong>H·∫øt h·∫°n:</strong> {{ t.end_date }}
                                </div>
                                <div class="task-card__meta">
                                    <span class="status-badge {{ t.status_task | lower }}">{{ t.status_task | replace('_', ' ') | title }}</span>
                                </div>

                                <div class="task-card-actions">
                                    <form action="/update/task/{{t.task_id }}" method="POST" class="task-actions">
                                        {% if t.status_task | lower == 'finished' %}
                                            <button type="submit" class="btn btn-retract" name="action" value="retract">Thu h·ªìi</button>
                                        {% else %}
                                            <button type="submit" class="btn btn-complete" name="action" value="complete">Ho√†n th√†nh</button>
                                        {% endif %}
                                    </form>
                                    
                                    <button type="button" class="btn btn-edit"
                                        data-task-id="{{ t.task_id }}"
                                        data-title="{{ t.task_title }}"
                                        data-description="{{ t.task_description or '' }}"
                                        data-start="{{ t.start_date }}"
                                        data-end="{{ t.end_date }}">S·ª≠a</button>

                                    <form action="/delete_user/{{t.task_id}}"  method="POST" class="task-actions">
                                        <button type="submit" class="btn btn-delete" onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng vi·ªác n√†y kh√¥ng?');">X√≥a</button>
                                    </form>
                                </div>
                            </div>
                        </article>
                        {% else %}
                        <div class="empty-state">
                            <img src="https://cdni.iconscout.com/illustration/premium/thumb/empty-state-2130362-1800926.png" alt="Kh√¥ng c√≥ c√¥ng vi·ªác">
                            <p>‚ú® Tuy·ªát v·ªùi! B·∫°n kh√¥ng c√≥ c√¥ng vi·ªác n√†o. H√£y t·∫°o m·ªôt c√¥ng vi·ªác m·ªõi!</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="editTaskModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="card__title"><span>‚úèÔ∏è</span> Ch·ªânh s·ª≠a C√¥ng Vi·ªác</h2>
            <form id="editTaskForm" method="POST">
                <div class="form-group">
                    <label for="edit_task_title">T√™n c√¥ng vi·ªác:</label>
                    <input type="text" id="edit_task_title" name="task_title" required>
                </div>
                <div class="form-group">
                    <label for="edit_task_description">M√¥ t·∫£ chi ti·∫øt:</label>
                    <textarea id="edit_task_description" name="task_description" rows="4"></textarea>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="edit_start_date">Ng√†y b·∫Øt ƒë·∫ßu:</label>
                        <input type="text" id="edit_start_date" name="start_date" class="datetime-picker-edit" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_end_date">H·∫°n ch√≥t:</label>
                        <input type="text" id="edit_end_date" name="end_date" class="datetime-picker-edit" required>
                    </div>
                </div>
                <button type="submit" class="btn btn--primary"><span>üíæ</span> L∆∞u Thay ƒê·ªïi</button>
            </form>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // C·∫•u h√¨nh flatpickr cho form T·∫†O M·ªöI
        flatpickr(".datetime-picker", {
            enableTime: true,
            dateFormat: "Y-m-d\\TH:i:S",
            time_24hr: true,
        });

        // C·∫•u h√¨nh flatpickr cho form CH·ªàNH S·ª¨A (trong modal)
        const editPickrConfig = {
             enableTime: true,
             dateFormat: "Y-m-d\\TH:i:S",
             time_24hr: true,
        };
        const startEditPicker = flatpickr("#edit_start_date", editPickrConfig);
        const endEditPicker = flatpickr("#edit_end_date", editPickrConfig);


        document.addEventListener('DOMContentLoaded', function() {
            // ====== JavaScript cho l·ªçc Task (gi·ªØ nguy√™n) ======
            const taskCards = document.querySelectorAll('.task-card');
            const showAllBtn = document.getElementById('showAllTasks');
            // ... (to√†n b·ªô code l·ªçc c·ªßa b·∫°n gi·ªØ nguy√™n ·ªü ƒë√¢y) ...


            // ====== M·ªöI: JavaScript cho Modal Ch·ªânh S·ª≠a ======
            const modal = document.getElementById("editTaskModal");
            const editForm = document.getElementById("editTaskForm");
            const closeBtn = document.querySelector(".close-button");
            const editButtons = document.querySelectorAll(".btn-edit");

            // Khi ng∆∞·ªùi d√πng b·∫•m n√∫t "S·ª≠a"
            editButtons.forEach(button => {
                button.addEventListener("click", function() {
                    // L·∫•y d·ªØ li·ªáu t·ª´ c√°c thu·ªôc t√≠nh data-* c·ªßa n√∫t ƒë∆∞·ª£c b·∫•m
                    const taskId = this.dataset.taskId;
                    const title = this.dataset.title;
                    const description = this.dataset.description;
                    const startDate = this.dataset.start;
                    const endDate = this.dataset.end;

                    // C·∫≠p nh·∫≠t action c·ªßa form trong modal
                    editForm.action = `/update_task/${taskId}`;

                    // ƒêi·ªÅn d·ªØ li·ªáu v√†o c√°c tr∆∞·ªùng input trong modal
                    document.getElementById("edit_task_title").value = title;
                    document.getElementById("edit_task_description").value = description;
                    
                    // D√πng flatpickr API ƒë·ªÉ set ng√†y th√°ng
                    startEditPicker.setDate(startDate, true);
                    endEditPicker.setDate(endDate, true);

                    // Hi·ªÉn th·ªã modal
                    modal.style.display = "block";
                });
            });

            // Khi ng∆∞·ªùi d√πng b·∫•m v√†o n√∫t (x) ƒë·ªÉ ƒë√≥ng modal
            closeBtn.onclick = function() {
                modal.style.display = "none";
            }

            // Khi ng∆∞·ªùi d√πng b·∫•m ra ngo√†i modal, c≈©ng ƒë√≥ng n√≥ l·∫°i
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        });
        
        // ƒêo·∫°n code l·ªçc task c·ªßa b·∫°n n√™n ƒë∆∞·ª£c ƒë·∫∑t trong s·ª± ki·ªán DOMContentLoaded
        // V√≠ d·ª•:
        document.addEventListener('DOMContentLoaded', function() {
            // ... (to√†n b·ªô code l·ªçc task c·ªßa b·∫°n ƒë·∫∑t ·ªü ƒë√¢y)
        });

    </script>
</body>
</html>